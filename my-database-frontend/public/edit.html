<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Edit Record</title>

    <link rel="stylesheet" href="style.css" />
  </head>
  <body style="display: block; padding: 20px 50px">
    <h2 id="editTitle">Edit Record</h2>
    <div id="editFormContainer">Loading...</div>

    <script type="module">
      import { showMessage } from "./script.js";

      // Read URL parameters
      const params = new URLSearchParams(window.location.search);
      const tableName = params.get("table");
      const id = params.get("id");

      if (!tableName || !id) {
        document.getElementById("editFormContainer").innerHTML =
          "<p style='color:red'>Invalid parameters.</p>";
      }

      document.getElementById(
        "editTitle"
      ).innerText = `Edit ${tableName} (ID: ${id})`;

      // STEP 1: Fetch the record to pre-fill form
      async function loadRecord() {
        const response = await fetch(
          `/.netlify/functions/${tableName}-get-item-by-id?id=${id}`
        );
        const data = await response.json();
        console.log("data : ", data);

        if (!response.ok) {
          document.getElementById(
            "editFormContainer"
          ).innerHTML = `<p style="color:red">Failed to load record: ${data.error}</p>`;
          return;
        }

        if (tableName == "product") {
          buildProductForm(data);
        } else if (tableName == "sales") {
          buildSalesForm(data);
        } else {
          buildDynamicForm(data);
        }
      }


      //Product
      function buildProductForm(record) {
        let html=    `<form id="productForm">
            <label style="font-weight: bold">Product Name:</label><br />
            <input type="text" id="product_name" name="product_name" value="${record.product_name ?? ""}"" required /><br />

            <label style="font-weight: bold">Category:</label><br />
            <select id="product_category" name="category_id" required></select><br />

            <label style="font-weight: bold">Supplier:</label><br />
            <select id="product_supplier" name="supplier_id" required></select><br />

            <label style="font-weight: bold">Price:</label><br />
            <input type="number" step="0.01" min="0"  id="product_price"  name="price"value="${record .price ?? ""}" required /><br />

            <label style="font-weight: bold">Quantity:</label><br />
            <input type="number" min="0" id="product_quantity" name="quantity_in_stock" value="${record.quantity_in_stock ?? ""}" required /><br />

            <button type="submit">Save</button>
            <button type="button" id="cancelBtn">Cancel</button>
            </form>`

        document.getElementById("editFormContainer").innerHTML = html;

        //Load category
        fetch("/.netlify/functions/category-get-items")
            .then(response => response.json())
            .then(data => {
            const categorySelect = document.getElementById("product_category");
            data.forEach(category => {
                let option = document.createElement("option");
                option.value = category.category_id; 
                option.textContent = category.category_name;
                if (category.category_id === record.category_id) {
                    option.selected = true; // auto-select matching supplier
                }
                categorySelect.appendChild(option);
            });
        });        

        // Load suppliers
        fetch("/.netlify/functions/suppliers-get-items")
            .then(response => response.json())
            .then(data => {
            const supplierSelect = document.getElementById("product_supplier");
            data.forEach(supplier => {
                let option = document.createElement("option");
                option.value = supplier.supplier_id;
                option.textContent = supplier.supplier_name;
                if (supplier.supplier_id === record.supplier_id) {
                    option.selected = true; // auto-select matching supplier
                }
                supplierSelect.appendChild(option);
            });
        });

        document
          .getElementById("productForm")
          .addEventListener("submit", saveChanges);
        document.getElementById("cancelBtn").addEventListener("click", () => {
          window.location.href = "/index.html";
        });
      }


      //SALES
      function buildSalesForm(record) {

        let html = `<form id="salesForm">
            <label style="font-weight: bold">Customer:</label><br />
            <select id="sales_customer" name="customer_id" required></select><br />

            <label style="font-weight: bold">Product:</label><br />
            <select id="sales_product" name="product_id" required></select><br />

            <label style="font-weight: bold">Quantity:</label><br />
            <input type="number" min="0" id="sales_quantity_sold" name="quantity_sold" value="${ record.quantity_sold ?? ""}" required /><br />

            <label style="font-weight: bold">Total Amount:</label><br />
            <input type="number" step="0.01" min="0"  id="sales_total_amount" name="total_amount" value="${record.total_amount ?? ""}" required /><br />

            <button type="submit">Save</button>
            <button type="button" id="cancelBtn">Cancel</button>
          </form>`

          document.getElementById("editFormContainer").innerHTML = html;

            fetch("/.netlify/functions/customer-get-items")
            .then(response => response.json())
            .then(data => {
              const categorySelect = document.getElementById("sales_customer");
              data.forEach(customer => {
                let option = document.createElement("option");
                option.value = customer.customer_id; 
                option.textContent = customer.customer_name;
                if(customer.customer_id === record.customer_id){
                  option.selected = true;
                }
                categorySelect.appendChild(option);
              });
            });

          // Load product
          fetch("/.netlify/functions/product-get-items")
            .then(response => response.json())
            .then(data => {
              const supplierSelect = document.getElementById("sales_product");
              data.forEach(product => {
                let option = document.createElement("option");
                option.value = product.product_id;
                option.textContent = product.product_name;
                if (product.product_id === record.product_id) {
                    option.selected = true;
                }
                supplierSelect.appendChild(option);
              });
            });

        document
          .getElementById("salesForm")
          .addEventListener("submit", saveChanges);
        document.getElementById("cancelBtn").addEventListener("click", () => {
          window.location.href = "/index.html";
        });


      }

      // STEP 2: Build form fields dynamically based on response
      function buildDynamicForm(record) {
        let html = `<form id="dynamicEditForm">`;

        Object.entries(record).forEach(([key, value]) => {
          // Skip auto-generated ID fields
          if (key.endsWith("_id")) return;

          html += `
                    <div class="form-control">
                        <label>${key}</label><br/>
                        <input type="text" name="${key}" value="${value ?? ""}" />
                    </div>
                `;
        });

        html += `
                <button type="submit">Save</button>
                <button type="button" id="cancelBtn">Cancel</button>
            </form>
            `;

        document.getElementById("editFormContainer").innerHTML = html;

        // Attach listeners
        document
          .getElementById("dynamicEditForm")
          .addEventListener("submit", saveChanges);
        document.getElementById("cancelBtn").addEventListener("click", () => {
          window.location.href = "/index.html";
        });
      }

      // STEP 3: Handle Save button
      async function saveChanges(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const updatedData = {};

        formData.forEach((value, key) => (updatedData[key] = value));
        
        console.log("data : ", updatedData)

        const response = await fetch(
          `/.netlify/functions/${tableName}-update-item-by-id?id=${id}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedData),
          }
        );

        const result = await response.json();

        if (!response.ok) {
          alert("Update failed: " + (result.error || "Unknown error"));
          return;
        }

        alert("Record updated successfully!");
        window.location.href = "/index.html";
      }

      loadRecord();
    </script>

  </body>
</html>
